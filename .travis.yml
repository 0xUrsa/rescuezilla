language: minimal

# The build bot OS environment does not really matter, as the docker image
# provides the primary host environment for the build. However, a more recent
# OS provides a more recent Docker release, which means additional Docker
# functionality.
dist: bionic

services:
  - docker

# Launches Docker container to act as 'host system'. See BUILD.ISO.IMAGE.md for more information.
before_install:
- docker ps -a
  # Build an immutable docker image from the Dockerfile, labelled with a
  # meaningful tag
- docker build --tag builder.image .
  # Construct a (mutable) docker container from the docker image, give it
  # extended privileges (required for the chroot bind mount), label it with a
  # meaningful name, execute the application /bin/cat, so the container doesn't
  # automatically exit
- docker run --rm --detach --privileged --name builder.container -v `pwd`:/home/redobackup -t builder.image cat
script:
  # Execute the Makefile's install target within the docker container. This step
  # may take some time. Hundreds of megabytes of packages are downloaded from the
  # Ubuntu mirror during a build.
- docker exec -it builder.container make -C /home/redobackup install
